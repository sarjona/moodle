YUI.add("moodle-atto_h5p-button",function(e,t){var n={CONTENTWARNING:"att_h5p_contentwarning",H5PBROWSER:"openh5pbrowser",INPUTALT:"atto_h5p_altentry",INPUTH5PFILE:"atto_h5p_file",INPUTH5PURL:"atto_h5p_url",INPUTSUBMIT:"atto_h5p_urlentrysubmit",OPTION_DOWNLOAD_BUTTON:"atto_h5p_option_download_button",OPTION_COPYRIGHT_BUTTON:"atto_h5p_option_copyright_button",OPTION_EMBED_BUTTON:"atto_h5p_option_embed_button",URLWARNING:"atto_h5p_warning"},r={CONTENTWARNING:"."+n.CONTENTWARNING,H5PBROWSER:"."+n.H5PBROWSER,INPUTH5PFILE:"."+n.INPUTH5PFILE,INPUTH5PURL:"."+n.INPUTH5PURL,INPUTSUBMIT:"."+n.INPUTSUBMIT,OPTION_DOWNLOAD_BUTTON:"."+n.OPTION_DOWNLOAD_BUTTON,OPTION_COPYRIGHT_BUTTON:"."+n.OPTION_COPYRIGHT_BUTTON,OPTION_EMBED_BUTTON:"."+n.OPTION_EMBED_BUTTON,URLWARNING:"."+n.URLWARNING},i="atto_h5p",s='<form class="atto_form">{{#if canEmbed}}<div class="mb-4"><label for="{{elementid}}_{{CSS.INPUTH5PURL}}">{{get_string "enterurl" component}}</label><div style="display:none" role="alert" class="alert alert-warning mb-1 {{CSS.URLWARNING}}">{{get_string "invalidh5purl" component}}</div><textarea rows="3" class="form-control {{CSS.INPUTH5PURL}}" type="url" id="{{elementid}}_{{CSS.INPUTH5PURL}}" />{{embedURL}}</textarea><div class="description small mb-2">{{get_string "enterurl_desc" component}}</div></div>{{/if}}{{#if canUpload}}<div class="mb-4"><label for="{{elementid}}_{{CSS.H5PBROWSER}}">{{get_string "h5pfile" component}}</label><div style="display:none" role="alert" class="alert alert-warning mb-1 {{CSS.CONTENTWARNING}}">{{get_string "noh5pcontent" component}}</div><div class="input-group input-append w-100"><input class="form-control {{CSS.INPUTH5PFILE}}" type="url" value="{{fileURL}}" id="{{elementid}}_{{CSS.INPUTH5PFILE}}" size="32"/><span class="input-group-append"><button class="btn btn-secondary {{CSS.H5PBROWSER}}" type="button">{{get_string "browserepositories" component}}</button></span></div><div class="description small mb-2">{{get_string "h5pfile_desc" component}}</div><div class="mt-2 mb-1 ml-2">{{get_string "h5poptions" component}}</div><div class="form-check ml-2"><input type="checkbox" {{optionDownloadButton}} class="form-check-input {{CSS.OPTION_DOWNLOAD_BUTTON}}"id="{{elementid}}_h5p-option-allow-download"/><label class="form-check-label" for="{{elementid}}_h5p-option-allow-download">{{get_string "downloadbutton" component}}</label></div><div class="form-check ml-2"><input type="checkbox" {{optionEmbedButton}} class="form-check-input {{CSS.OPTION_EMBED_BUTTON}}" id="{{elementid}}_h5p-option-embed-button"/><label class="form-check-label" for="{{elementid}}_h5p-option-embed-button">{{get_string "embedbutton" component}}</label></div><div class="form-check ml-2"><input type="checkbox" {{optionCopyrightButton}} class="form-check-input {{CSS.OPTION_COPYRIGHT_BUTTON}}" id="{{elementid}}_h5p-option-copyright-button"/><label class="form-check-label" for="{{elementid}}_h5p-option-copyright-button">{{get_string "copyrightbutton" component}}</label></div></div>{{/if}}<div class="text-center"><button class="btn btn-secondary {{CSS.INPUTSUBMIT}}" type="submit">{{get_string "saveh5p" component}}</button></div></form>',o='<div class="position-relative h5p-embed-placeholder" data-h5pplaceholder="url"><div class="attoh5poverlay"></div><iframe id="h5pcontent" class="h5pcontent" src="{{url}}/embed" data-type="url" data-url="{{url}}" width="100%" height="637" frameborder="0"allowfullscreen="{{allowfullscreen}}" allowmedia="{{allowmedia}}"></iframe><script src="'+M.cfg.wwwroot+'/lib/editor/atto/plugins/h5p/js/h5p-resizer.js"'+'charset="UTF-8"></script>'+"</div>"+"</div>"+"<div><br></div>",u='<div class="position-relative h5p-embed-placeholder" data-h5pplaceholder="embed"><div class="attoh5poverlay"></div><div class="h5pcontent" data-type="embed">{{{iframe}}}</div><script src="'+M.cfg.wwwroot+'/lib/editor/atto/plugins/h5p/js/h5p-resizer.js"'+'charset="UTF-8"></script>'+"</div>"+"</div>"+"<div><br></div>",a='<div class="position-relative h5p-file-placeholder" data-h5pplaceholder="file"><div class="attoh5poverlay"></div><iframe id="h5pcontent" class="h5pcontent" src="'+M.cfg.wwwroot+"/h5p/embed.php?url={{h5pfile}}&frame=1"+"{{#if optionDownloadButton}}&export=1{{/if}}"+"{{#if optionEmbedButton}}&embed=1{{/if}}"+'{{#if optionCopyrightButton}}&copyright=1{{/if}}" '+'data-file="{{h5pfile}}" data-type="file" width="100%" height="230" frameborder="0" '+'data-export="{{#if optionDownloadButton}}=1{{/if}}" '+'data-embed="{{#if optionEmbedButton}}=1{{/if}}" '+'data-copyright="{{#if optionCopyrightButton}}=1{{/if}}" '+'allowfullscreen="{{allowfullscreen}}" allowmedia="{{allowmedia}}">'+"</iframe>"+'<script src="'+M.cfg.wwwroot+'/lib/editor/atto/plugins/h5p/js/h5p-resizer.js"'+'charset="UTF-8"></script>'+"</div>"+"</div>"+"<div><br></div>";e.namespace("M.atto_h5p").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_form:null,_placeholderH5P:null,_allowedmethods:"none",initializer:function(){this._allowedmethods=this.get("allowedmethods");if(this._allowedmethods==="none")return;this.addButton({icon:"icon",iconComponent:"atto_h5p",callback:this._displayDialogue,tags:".attoh5poverlay",tagMatchRequiresAll:!1}),this.editor.delegate("dblclick",this._handleDblClick,".attoh5poverlay",this),this.editor.delegate("click",this._handleClick,".attoh5poverlay",this)},_handleDblClick:function(){this._displayDialogue()},_handleClick:function(e){var t=e.target,n=this.get("host").getSelectionFromNode(t);this.get("host").getSelection()!==n&&this.get("host").setSelection(n)},_displayDialogue:function(){this._currentSelection=this.get("host").getSelection(),this._placeholderH5P=this._getH5PIframe();if(this._currentSelection===!1)return;var e=this.getDialogue({headerContent:M.util.get_string("h5pproperties",i),width:"auto",focusAfterHide:!0});e.set("bodyContent",this._getDialogueContent()).show()},_getH5PIframe:function(){var t=this.get("host").getSelectionParentNode();if(!t)return;var n=t.getAttribute("data-h5pplaceholder"
);if(n=="url"||n=="file")return e.one(t).one("iframe.h5pcontent");if(n=="embed")return e.one(t).one("div.h5pcontent")},_getPermissions:function(){var e={canUpload:!1,canUploadAndEbmed:!1,canEmbed:!1};this.get("host").canShowFilepicker("h5p")&&(this._allowedmethods==="both"?(e.canUploadAndEmbed=!0,e.canUpload=!0):this._allowedmethods==="upload"&&(e.canUpload=!0));if(this._allowedmethods==="both"||this._allowedmethods==="embed")e.canEmbed=!0;return e},_getDialogueContent:function(){var t=this._getPermissions(),r,o,u="active",a,f,l,c;if(this._placeholderH5P){var h=this._placeholderH5P.getAttribute("data-type");h==="file"?(r=this._placeholderH5P.getAttribute("data-file"),f=this._placeholderH5P.getAttribute("data-export")?"checked":"",l=this._placeholderH5P.getAttribute("data-embed")?"checked":"",c=this._placeholderH5P.getAttribute("data-copyright")?"checked":"",u="",a="active"):h==="url"?o=this._placeholderH5P.getAttribute("data-url"):h==="embed"&&(o=this._placeholderH5P.getContent())}var p=e.Handlebars.compile(s),d=e.Node.create(p({elementid:this.get("host").get("elementid"),CSS:n,component:i,canUpload:t.canUpload,canEmbed:t.canEmbed,fileURL:r,embedURL:o,fileActive:a,embedActive:u,canUploadAndEmbed:t.canUploadAndEmbed,optionDownloadButton:f,optionEmbedButton:l,optionCopyrightButton:c}));return this._form=d,this._setEventListeners(),d},_filepickerCallback:function(e){if(e.url!==""){var t=this._form.one(r.INPUTH5PFILE);t.set("value",e.url),this._form.one(r.INPUTH5PURL).set("value",""),this._removeWarnings()}},_setEventListeners:function(){var e=this._form,t=this._getPermissions();e.one(r.INPUTSUBMIT).on("click",this._setH5P,this),t.canUpload&&e.one(r.H5PBROWSER).on("click",function(){this.get("host").showFilepicker("h5p",this._filepickerCallback,this)},this),t.canUploadAndEmbed&&(e.one(r.INPUTH5PFILE).on("change",function(){e.one(r.INPUTH5PURL).set("value",""),this._removeWarnings()},this),e.one(r.INPUTH5PURL).on("change",function(){e.one(r.INPUTH5PFILE).set("value",""),this._removeWarnings()},this))},_removeWarnings:function(){var e=this._form;e.one(r.URLWARNING).setStyle("display","none"),e.one(r.CONTENTWARNING).setStyle("display","none")},_setH5P:function(t){var n=this._form,i=n.one(r.INPUTH5PURL).get("value"),s,f=this.get("host"),l,c=this._getPermissions();c.canEmbed&&(i=n.one(r.INPUTH5PURL).get("value")),c.canUpload&&(l=n.one(r.INPUTH5PFILE).get("value")),t.preventDefault();if(this._updateWarning())return;f.focus();if(i!==""){if(this._placeholderH5P)this._placeholderH5P.setAttribute("src",i);else{f.setSelection(this._currentSelection);if(this._validEmbed(i)){var h=e.Handlebars.compile(u),p=/^(<iframe.*<\/iframe>)/,d=i.match(p)[0];s=h({iframe:d})}else{var v=e.Handlebars.compile(o);s=v({url:i,allowfullscreen:"allowfullscreen",allowmedia:"geolocation *; microphone *; camera *; midi *; encrypted-media *"})}this.get("host").insertContentAtFocusPoint(s)}this.markUpdated()}else if(l!==""){f.setSelection(this._currentSelection);var m=n.one(r.OPTION_DOWNLOAD_BUTTON).get("checked"),g=n.one(r.OPTION_EMBED_BUTTON).get("checked"),y=n.one(r.OPTION_COPYRIGHT_BUTTON).get("checked"),b=e.Handlebars.compile(a);s=b({h5pfile:l,allowfullscreen:"allowfullscreen",allowmedia:"geolocation *; microphone *; camera *; midi *; encrypted-media *",optionDownloadButton:m,optionEmbedButton:g,optionCopyrightButton:y}),this.get("host").insertContentAtFocusPoint(s),this.markUpdated()}this.getDialogue({focusAfterHide:null}).hide()},_validEmbed:function(e){var t=new RegExp("^(<iframe).*(<\\/iframe>)");return!!t.test(e)},_validURL:function(e){var t=new RegExp("^(https?:\\/\\/)?((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|((\\d{1,3}\\.){3}\\d{1,3}))(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*");return!!t.test(e)},_updateWarning:function(){var e=this._form,t=!0,n,i,s=this._getPermissions();if(s.canEmbed){n=e.one(r.INPUTH5PURL).get("value");if(n!=="")return this._validURL(n)?(e.one(r.URLWARNING).setStyle("display","none"),t=!1):this._validEmbed(n)?(e.one(r.URLWARNING).setStyle("display","none"),t=!1):(e.one(r.URLWARNING).setStyle("display","block"),t=!0),t}return s.canUpload&&(i=e.one(r.INPUTH5PFILE).get("value"),i!==""?(e.one(r.CONTENTWARNING).setStyle("display","none"),t=!1):(e.one(r.CONTENTWARNING).setStyle("display","block"),t=!0)),t}},{ATTRS:{allowedmethods:{value:null}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});
